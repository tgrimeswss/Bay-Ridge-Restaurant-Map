function initMap(){var e=[{featureType:"water",stylers:[{color:"#FFFFFF"}]},{featureType:"administrative",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"},{weight:6}]}];map=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(40.6251388,-74.0282899),zoom:14,styles:e});var o=new google.maps.InfoWindow;createWindow=function(){r(this,o)};!function(){for(var e=0;e<locations.length;e++){var o=locations[e].location,r=locations[e].title;marker=new google.maps.Marker({position:o,map:map,title:r,website:locations[e].website,imgs:locations[e].imgs,resID:locations[e].resID,animation:google.maps.Animation.DROP,icon:"forkknife.png",id:e}),locations[e].marker=marker,ViewModel.markerArray()[e].marker=marker,marker.zomato=ViewModel.zomatoReviews,marker.popInfoWindow=createWindow,marker.addListener("click",createWindow),markers.push(marker)}}();var r=function(e,o){reviews=[],zomatoReviews=function(r){$.ajax({dataType:"json",url:"https://developers.zomato.com/api/v2.1/reviews?res_id="+e.resID,headers:{"user-key":"19b6f28a79ec4858856da336e1fee593"},success:function(r,i,t){clearReviews=function(){reviews.splice(0,reviews.length)},ViewModel.reviewList.removeAll();for(var a=0;a<r.user_reviews.length;a++)ViewModel.reviewList.push('"'+r.user_reviews[a].review.review_text+'"'),reviews.push('"'+r.user_reviews[a].review.review_text+'"');if(o.marker!=e){o.setContent(""),o.marker=e,o.addListener("closeclick",function(){o.marker=null});(new google.maps.StreetViewService).getPanoramaByLocation(e.position,50,function(r,i){if(i==google.maps.StreetViewStatus.OK){console.log("Name: "+e.title+". GPS: "+e.position);var t=r.location.latLng,a=google.maps.geometry.spherical.computeHeading(t,e.position);o.setContent('<div style="text-align:center;"><h2><a style="text-decoration:none;color:black;" href="'+e.website+'">'+e.title+'</a></h2><div style="border: solid red 1px;"><div id="pano"</div></div><div id="listView" style="float:right;"><h3>Zomato Reviews</h3>'+reviews+"</div>");var n={position:t,pov:{heading:a,pitch:30}};new google.maps.StreetViewPanorama(document.getElementById("pano"),n)}else o.setContent("<div>"+e.title+"</div><div>No Street View Found</div>")}),o.open(map,e),map.panTo(e.position),map.setZoom(15),e.setAnimation(google.maps.Animation.DROP)}},error:function(e,o,r){alert("Hmm.. There seems to a problem with our Zomato API. Check back in with us later. We are working on to fix it.")}})},zomatoReviews()}}var map,markers=[];window.onerror=function(e,o,r){return alert("Hmm.. There seems to be a problem loading this page.\n\nMessage: "+e+"\nURL : "+o+"\nLine : "+r),!0},mapError=function(){alert("There seems to be a map error")};var Location=function(e){this.title=e.title},ViewModel={markerArray:ko.observableArray(),query:ko.observable(""),reviewList:ko.observableArray(),search:function(e){for(var o=0;o<markers.length;o++)markers[o].setVisible(!1);ViewModel.reviewList.removeAll(),ViewModel.markerArray.removeAll();for(var r in locations)locations[r].title.toLowerCase().indexOf(e.toLowerCase())>=0&&(ViewModel.markerArray.push(locations[r]),markers[r].setVisible(!0))},showAllmarkers:function(){for(var e=0;e<markers.length;e++)markers[e].setVisible(!0),markers[e].setAnimation(google.maps.Animation.DROP)},makeLocations:function(e){var o=this;e.forEach(function(e){o.markerArray.push(new Location(e))})},goToLocation:function(e,o){for(var r=0;r<markers.length;r++)markers[r].setVisible(!1);e.marker.setVisible(!0),e.marker.popInfoWindow()}};ViewModel.makeLocations(locations),ViewModel.query.subscribe(ViewModel.search),ko.applyBindings(ViewModel);
